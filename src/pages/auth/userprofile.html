<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Profile</title>
  
  <!-- Favicon and app icons -->
  <link rel="icon" href="../../assets/images/favicon.svg" type="image/svg+xml">
  <link rel="icon" href="../../assets/images/favicon.ico" type="image/x-icon">
  <link rel="apple-touch-icon" href="../../assets/images/apple-touch-icon.png">
  <link rel="icon" sizes="96x96" href="../../assets/images/favicon-96x96.png">
  <link rel="manifest" href="../../assets/images/site.webmanifest">
  
  <link rel="stylesheet" href="../../styles/stylesheet.css">
  <style>
    .user-info {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInUp 0.8s ease-out forwards;
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
}

.img img.profile {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    transition: transform 0.3s ease-in-out;
}

.img img.profile:hover {
    transform: scale(1.05);
}

.user-info:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
}

h2, p {
    opacity: 0;
    transform: translateY(10px);
    animation: slideIn 0.5s ease-out forwards;
}

p:nth-child(2) { animation-delay: 0.2s; }
p:nth-child(3) { animation-delay: 0.4s; }
p:nth-child(4) { animation-delay: 0.6s; }
p:nth-child(5) { animation-delay: 0.8s; }
p:nth-child(6) { animation-delay: 1.0s; }
p:nth-child(7) { animation-delay: 1.2s; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.user-info a {
    text-decoration: none;
    transition: color 0.3s ease-in-out;
}

.user-info a:hover {
    color: #ffffff;
}

.loading {
    position: relative;
    overflow: hidden;
}

.loading::after {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
    animation: shimmer 1.5s infinite linear;
}

@keyframes shimmer {
    from {
        transform: translateX(-100%);
    }
    to {
        transform: translateX(100%);
    }
}
  </style>

</head>
<body>
  <div class="bg-image"></div>

<div class="header">
  <nav>
    <h2>ELAD School of Potentials Therapy Center</h2>
    <ul>
      <div class="dropdown">
        <a href="userprofile.html">
          <div id="emailBtn"></div>
        </a>       
        <div class="dropdown-content">
          <a href="../calendar/calendaruser.html">View Calendar</a>
          <li><a href="../contact.html">Contact Us</a></li>
          <li><a href="#" id="verifyBtn">Verify E-mail</a></li>
          <li><a href="#" id="logoutBtn">Logout</a></li>
        </div>
      </div>
    </ul>
  </nav>
</div>

  <div class="user-info">

    <div class="img"><img src='../../assets/images/login_profile.png' class="profile">  </div>
    <strong>
    <h2>Personal Info</h2>
    <p id="email"></p>
    <p id="id"></p>
    <p id="name"></p>
    <br>
    <h2>Appointment Status</h2>
    <p id="appointmentStatus"></p>
    <p id="appointmentType"></p>
    <p id="appointmentDate"></p>
    <p id="appointmentTime"></p>
    <p id="paymentStatus"></p>
    <p id="appointmentNotif"></p>
    </strong>
    <br><br>
    <p>If you want to set up a new Appointment, please <a href="../contact.html">Contact Us</a>.</p>

</div>


<div class="footer"> 
  <div class="social-links">
    <a href="https://www.facebook.com/ELADSchoolofPotentials" class="footer-style-button">Facebook</a>
  </div>
  <p>&copy; 2025 ELAD School of Potentials Therapy Center</p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js"; 
  import { getFirestore, collection, doc, getDocs, query, where, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCZfi1aIc3zDdZD7NR7kN2Jm4hnCtPHWcQ",
    authDomain: "appointment-scheduling-s-57d01.firebaseapp.com",
    databaseURL: "https://appointment-scheduling-s-57d01-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "appointment-scheduling-s-57d01",
    storageBucket: "appointment-scheduling-s-57d01.firebasestorage.app",
    messagingSenderId: "1069885306589",
    appId: "1:1069885306589:web:b31768194add4087754d34",
    measurementId: "G-KQ4PQZZZBM"
  };
  const app = initializeApp(firebaseConfig);
        const auth = getAuth(app); 
        const db = getFirestore();
    
    

        
        function updateDropdownEmail(user) {
            const emailButton = document.getElementById('emailBtn'); 
            if (user) {
                emailButton.textContent = user.email;
            } else {
                emailButton.textContent = 'Guest'; 
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => { 
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    updateDropdownEmail(user);
                    document.getElementById("email").innerHTML = "Email: " + user.email; 

                    user.reload()
                        .then(() => {
                            const verifyBtn = document.getElementById('verifyBtn');
                            if (user.emailVerified) {
                                verifyBtn.textContent = "Email Verified";
                                verifyBtn.removeAttribute('href'); 
                            } else {
                                verifyBtn.textContent = "Verify E-mail";
                                verifyBtn.href = "#"; 
                            }
                            getUserDataByEmail(user.email);
                        })
                        .catch((error) => {
                            console.log("Error reloading user:", error);
                            alert("Error reloading user: " + error.message); 
                        });

                } else {
                    console.log("No user is signed in.");
                    window.location.href = 'login.html'; 
                }
            });
        }); 
  

        async function getUserDataByEmail(email) {
    try {
        const usersRef = collection(db, 'appointments');
        const q = query(usersRef, where("email", "==", email));
        const querySnapshot = await getDocs(q); 
  
        if (!querySnapshot.empty) {
            const userData = querySnapshot.docs[0].data(); 
            console.log("User Data from Firestore:", userData);
  
            document.getElementById('name').textContent = `Name: ${userData.firstName + " " + userData.middleName + " " + userData.surname || 'N/A'}`; 
            document.getElementById('appointmentType').textContent = `Type: ${userData.appointmentType || 'N/A'}`;
            document.getElementById('appointmentDate').textContent = `Date: ${formatDate(userData.appointmentDate) || 'N/A'}`;
            document.getElementById('appointmentTime').textContent = `Time: from ${formatTime(userData.appointmentTimeStart) + " to " + formatTime(userData.appointmentTimeEnd) || 'N/A'}`;
            document.getElementById('paymentStatus').textContent = `Payment Status: ${userData.paymentStatus || 'N/A'}`;  
            document.getElementById('appointmentStatus').textContent = `Status: ${userData.appointmentStatus || 'N/A'}`;  
        
            const appointmentDate = new Date(userData.appointmentDate);
            const currentDate = new Date();

            // Ensure both dates are at midnight to ignore time components
            const normalizedCurrentDate = new Date(currentDate.setHours(0, 0, 0, 0)); 
            const normalizedAppointmentDate = new Date(appointmentDate.setHours(0, 0, 0, 0)); 

            // Create dates for reminders: 3 days before and 1 day before
            const threeDaysBefore = new Date(normalizedAppointmentDate);
            threeDaysBefore.setDate(normalizedAppointmentDate.getDate() - 3);
  
            const twentyFourHoursBefore = new Date(normalizedAppointmentDate);
            twentyFourHoursBefore.setDate(normalizedAppointmentDate.getDate() - 1);

            console.log("Normalized Current Date: ", normalizedCurrentDate);
            console.log("Normalized Appointment Date: ", normalizedAppointmentDate);
            console.log("Three Days Before: ", threeDaysBefore);
            console.log("24 Hours Before: ", twentyFourHoursBefore);

            let notification = '';
        
            // Compare dates only based on the day
            if (normalizedCurrentDate.getTime() === threeDaysBefore.getTime()) {
                notification = 'Reminder: Your appointment is in 3 days!';
            } else if (normalizedCurrentDate.getTime() === twentyFourHoursBefore.getTime()) {
                notification = 'Reminder: Your appointment is in 24 hours!';
            }
  
            document.getElementById('appointmentNotif').textContent = notification;
  
        } else {
            console.log("No user found with this email.");
        }
    } catch (error) {
        console.log("Error getting Firestore data:", error);
        alert("Error getting user data: " + error.message); 
    }
}

document.addEventListener('DOMContentLoaded', (event) => { 
    onAuthStateChanged(auth, (user) => {
        if (user) {
            updateDropdownEmail(user);
            document.getElementById("email").innerHTML = "Email: " + user.email;

            user.reload()
                .then(() => {
                    const verifyBtn = document.getElementById('verifyBtn');
                    if (user.emailVerified) {
                        verifyBtn.textContent = "Email Verified";
                        verifyBtn.removeAttribute('href'); 
                        // Display name and appointment status when email is verified
                        document.getElementById('name').style.display = 'block';
                        document.getElementById('appointmentStatus').style.display = 'block';
                        getUserDataByEmail(user.email);
                    } else {
                        verifyBtn.textContent = "Verify E-mail";
                        verifyBtn.href = "#"; 
                        // Hide name and appointment status when email is not verified
                        document.getElementById('name').style.display = 'none';
                        document.getElementById('appointmentStatus').style.display = 'none';
                    }
                })
                .catch((error) => {
                    console.log("Error reloading user:", error);
                    alert("Error reloading user: " + error.message); 
                });

        } else {
            console.log("No user is signed in.");
            window.location.href = 'login.html'; 
        }
    });
});


function formatDate(dateString) {
    const date = new Date(dateString);
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('en-US', options); 
}

function formatTime(timeString) {
    const time = new Date('1970-01-01T' + timeString + 'Z');
    if (isNaN(time)) {
        return 'Invalid Time'; 
    }
    const options = { hour: '2-digit', minute: '2-digit', hour12: true };
    return time.toLocaleTimeString('en-US', options); 
}


        const signOutUser = () => {
            signOut(auth)
                .then(() => {
                    console.log('Signed out successfully');
                    window.location.href = 'login.html'; 
                })
                .catch((error) => {
                    console.log('Error signing out:', error);
                    alert("Error: " + error.message); 
                });
        };

        const verifyEmail = () => {
            const user = auth.currentUser;
            if (user) {
                sendEmailVerification(user)
                    .then(() => {
                        alert("Verification email sent!");
                    })
                    .catch((error) => {
                        console.log('Error sending verification email:', error);
                        alert("Error: " + error.message); 
                    });
            }
        };

        document.getElementById('logoutBtn').addEventListener('click', signOutUser);
        document.getElementById('verifyBtn').addEventListener('click', verifyEmail); 
    </script>
</body>
</html>



  
